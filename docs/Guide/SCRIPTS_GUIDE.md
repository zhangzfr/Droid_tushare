# 🛠️ Droid-Tushare 脚本使用指南

`scripts/` 目录包含了用于特殊数据补全、历史数据修复和数据库维护的专项脚本。这些脚本是对主同步引擎（`main.py`）的有效补充，处理一些复杂的边缘案例。

---

## 📋 脚本目录概览

| 脚本名称 | 功能说明 | 核心逻辑 |
| :------- | :------- | :------- |
| `backfill_pledge_stat.py` | 补全股权质押统计数据 | 基于交易日历周五，填补缺失周 |
| `backfill_pledge_detail.py` | 获取股权质押明细 | 遍历股票代码，支持智能/强制更新 |
| `fix_daily_gaps.py` | 修复日线数据断点 | 扫描本地数据库记录，自动回补缺漏日 |
| `migrate_basic_to_stock.py` | 数据库表迁移工具 | 将基础信息表从旧库安全迁移至新库 |
| `validate_stocks.py` | 股票数据验证 | 对比本地与 Tushare 的股票日线完整性 |

---

## 🔍 核心脚本详解

### 1. 股权质押统计补全 (`backfill_pledge_stat.py`)

**背景**: 该 API 返回的是周频快照数据。主引擎逐日获取效率极低且容易出现大量重复。

**功能**:

- 自动查询 `trade_cal` 获取所有历史周五。
- 对比本地数据库，仅获取缺失日期。
- **批量存储**: 每获取 20 个周五数据执行一次批量写入，显著提升 I/O 效率。

**使用**:

```bash
python scripts/backfill_pledge_stat.py
```

---

### 2. 股权质押明细补全 (`backfill_pledge_detail.py`)

**背景**: `pledge_detail` 接口必须传入 `ts_code` 且无日期参数，返回所有历史明细。

**更新模式**:

- **默认模式**: 仅补全本地不存在 `ts_code` 的新股票。
- **智能模式 (`--smart`)**: 对比统计表和明细表的记录数，仅更新质押频率发生变化的股票。
- **强制模式 (`--force`)**: 清理所有旧数据并重新拉取全量。

**限流控制**:

- 针对 Tushare 分钟 400 次的限制，脚本内置计数器，每 350 次请求自动暂停 60 秒。

**使用**:

```bash
# 智能更新
python scripts/backfill_pledge_detail.py --smart
```

---

### 3. 日线断点修复 (`fix_daily_gaps.py`)

**功能**:

- 自动识别 `daily` 表中因网络或权限问题导致的非连续交易日数据。
- 支持按股票代码分批修复。

**使用**:

```bash
python scripts/fix_daily_gaps.py
```

---

## ⚙️ 通用设计模式

这些脚本遵循以下统一的设计原则：

1. **原子化连接**: 脚本运行开始时打开数据库连接，结束时自动安全关闭。
2. **批量化 (Batching)**: 避免每一条 API 成功就写库，而是合并多条/多股后进行增量插入。
3. **元数据感应**: 同步完成后会自动触发 `update_table_metadata`，更新表的最早/最晚日期。
4. **日志追踪**: 所有脚本均接入 `src.tushare_duckdb.logger`，输出详细的运行统计。

---

## ⚠️ 安全注意事项

- **备份**: 在运行 `--force` 模式或执行 `migrate` 脚本前，建议备份对应的 `.db` 文件。
- **资源利用**: 脚本运行期间会独占数据库写锁，此时 Dashboard 或其他查询可能会受限。
- **API 消耗**: 全量补全脚本会消耗大量 Tushare 积分，请确保账户额度充足。
