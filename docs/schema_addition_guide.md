# 手动添加表定义 (schema.py) 指导手册

本手册旨在指导如何手动在 `src/tushare_duckdb/schema.py` 文件中添加新的 DuckDB 表结构定义。

---

## 1. 为什么要手动添加？
虽然系统支持"配置驱动"的自动生成，但在以下场景建议手动添加：
- **复杂数据类型**：包含大量非主键的字符串字段（如：银行名称、地域、备注等）。
- **特殊主键**：需要定义复合主键（由多个列共同决定唯一性）。
- **字段备注**：希望在代码中通过注释保留字段的中文含义。

---

## 2. 准备工作
在开始前，请确认您已获知：
1. **表名** (Table Name)：例如 `cn_m`。
2. **字段列表**：每个字段的名称。
3. **主键列**：哪一列是唯一的识别码（通常是日期 `date` 或月份 `month`）。

---

## 3. 手动添加步骤

### 第一步：打开文件
定位并打开以下文件：
`src/tushare_duckdb/schema.py`

### 第二步：查找插入位置
在文件中找到 `TABLE_SCHEMAS = {` 这一行。您可以选择在字典的末尾（关闭括号 `}` 之前）或按照分类位置插入。

### 第三步：编写 SQL 语句
按照以下模板编写代码并粘贴到 `TABLE_SCHEMAS` 字典中：

```python
    '您的表名': """
        CREATE TABLE 您的表名 (
            字段1 VARCHAR PRIMARY KEY,  -- 通常是主键，如 month 或 date
            字段2 DOUBLE,               -- 数值型数据建议用 DOUBLE
            字段3 DOUBLE,               -- 更多数值字段...
            last_updated VARCHAR        -- 系统保留字段，用于记录最后更新时间
        )
    """,
```

### 示例：添加货币供应量表 (cn_m)
如果您要手动添加 `cn_m`，代码如下：

```python
    'cn_m': """
        CREATE TABLE cn_m (
            month VARCHAR PRIMARY KEY,     -- 月份 (YYYYMM)
            m0 DOUBLE,                     -- M0货币供应量
            m0_yoy DOUBLE,                 -- M0同比
            m0_mom DOUBLE,                 -- M0环比
            m1 DOUBLE,                     -- M1货币供应量
            m1_yoy DOUBLE,
            m1_mom DOUBLE,
            m2 DOUBLE,                     -- M2货币供应量
            m2_yoy DOUBLE,
            m2_mom DOUBLE,
            last_updated VARCHAR           -- 系统更新时间戳
        )
    """,
```

---

## 4. 关键规则说明

| 项目 | 说明 | 建议 |
| :--- | :--- | :--- |
| **引号** | SQL 语句必须被包裹在 `"""` (三个双引号) 中。 | 务必对齐缩进。 |
| **逗号** | 每个字段定义的末尾需要有逗号（最后一个字段除外）。 | 检查每行末尾。 |
| **VARCHAR** | 字符串类型。用于日期、月份、股票代码、代码、名称等。 | 日期必须用 VARCHAR。 |
| **DOUBLE** | 双精度浮点型。用于所有的金额、比率、指数等数值。 | 财务数据首选。 |
| **PRIMARY KEY** | 主键标识。被标识的列将不允许重复，系统会自动基于此去重。 | 通常加在日期字段后。 |

---

## 5. 常见问题 (FAQ)

**Q: 我写错字段类型了怎么办？**
A: 如果表已经创建，修改 `schema.py` 不会自动更新数据库。您需要使用 SQL 工具 `DROP TABLE 表名` 删除旧表，或者在 `settings.yaml` 中临时改个表名重新运行。

**Q: 字段名有空格或特殊字符怎么办？**
A: 使用双引号包裹字段名，例如 `"1w_b" DOUBLE`。

**Q: `last_updated` 字段是必须的吗？**
A: 强烈建议添加。系统会在每次成功存入数据时，自动将当前时间写入该列，方便后续排查数据新鲜度。
