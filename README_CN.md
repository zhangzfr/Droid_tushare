# Tushare to DuckDB 数据同步系统说明文档

## 1. 项目简介
本项目是一个高性能的金融数据 ETL（提取、转换、加载）工具，旨在将 Tushare Pro 接口的金融数据（股票、指数、期货、基金、宏观等）同步到本地 DuckDB 数据库中。

项目经过重构，采用了模块化架构，支持配置热更新、断点续传、增量更新和全链路日志记录。

## 2. 核心功能

### 2.1 多品类数据支持
支持以下数据类别的获取与存储：
- **股票 (Stock)**: 日线行情、每日指标、复权因子等。
- **股票列表 (Stock List)**: 股票基础信息、上市公司信息（对应菜单 12，无需日期）。
- **股票事件 (Stock Events)**: 历史更名、管理层、分红、沪深港通成分、交易日历（对应菜单 13，需日期范围）。
- **指数 (Index)**: 申万/同花顺/中信行业指数、大盘指数日线。
- **期货 (Future)**: 期货日线、南华期货指数、主力连续合约。
- **基金 (Fund)**: 场内/场外基金日线、净值数据。
- **期权 (Option)**: 交易所期权日微行情。
- **可转债 (Bond)**: 可转债日线、基本信息。
- **宏观 (Marco)**: Shibor、美债收益率等。
- **资金流向 (Moneyflow)**: 个股、板块资金流向。

### 2.2 智能更新策略
系统支持三种核心更新模式：
- **增量插入 (Insert New)**: 仅插入数据库中不存在的记录（基于唯一键去重）。默认模式，适合日常跑批。
- **覆盖模式 (Replace)**: 删除指定日期范围内的数据，重新拉取并插入。适合修正历史数据或重跑某段时间数据。
- **智能分页 (Smart Paging)**: 对于不支持日期参数的宽表（如基础信息表），自动比对本地最新记录，实现增量同步。

### 2.3 稳健性与观测
- **自动重试**: 对 Tushare API 的限频（每分钟访问限制）和网络错误进行自动退避重试。
- **集中式日志**: 所有操作日志记录在 `logs/` 目录下（按日期归档），同时输出到控制台。
- **空值处理**: 自动清洗日期为空的脏数据，防止数据库写入报错。

### 2.4 数据校验
提供强大的数据库状态校验功能（菜单选项 [11]），可检测：
- 数据覆盖率（如某段时间内是否有缺失天数）。
- 数据量异常（如某天数据量骤降）。
- 最早/最晚日期范围。

## 3. 通过本地配置管理
所有配置项已从代码中剥离，统一管理：

- **`settings.yaml`**: 定义了所有 API 接口参数、数据库表结构、字段映射、唯一键等核心逻辑。修改此文件可直接调整采集策略，无需改代码。
- **`.env`** (可选): 用于配置 `TUSHARE_TOKEN` 和数据库根目录 `DB_ROOT`，避免敏感信息硬编码。

## 4. 目录结构
```text
Droid_tushare/
├── src/
│   └── tushare_duckdb/    # 核心代码包
│       ├── config.py      # 配置加载器
│       ├── fetcher.py     # Tushare API 交互层
│       ├── storage.py     # DuckDB 存储层
│       ├── processor.py   # 数据处理与调度核心
│       ├── logger.py      # 日志模块
│       └── main.py        # 程序入口
├── settings.yaml          # 核心配置文件
├── safe_run.sh            # 安全测试脚本
├── requirements.txt       # 依赖列表
└── logs/                  # 运行日志
```

## 5. 使用指南

### 5.1 环境准备
确保已安装依赖（建议使用 conda 环境）：
```bash
pip install -r requirements.txt
```

### 5.2 安全测试模式（推荐）
首次运行时，建议使用安全脚本，它会将数据下载到临时的 `test_db_data/` 目录，**绝对不会**影响您正式的数据库文件。
```bash
./safe_run.sh
```

### 5.3 正式生产运行
确认测试无误后，运行主程序更新正式数据库（默认路径为 `/Users/robert/Developer/DuckDB`）：
```bash
python -m src.tushare_duckdb.main
```

### 5.4 交互操作流程
程序启动后会显示主菜单：
1. 输入数字（如 `1` 选择股票）进入子菜单。
2. **日期范围**: 输入开始/结束日期（YYYYMMDD），直接回车使用默认值（通常是上次更新后一天到今天）。
3. **选择表**: 输入 `all` 更新该类别下所有表，或输入表名（如 `daily,adj_factor`）单独更新。
4. **选择模式**:
   - `1`: 增量（最常用，速度快）
   - `2`: 覆盖（慎用，会删除指定时间段数据）

## 6. 注意事项

1. **Tushare 积分限制**:
   - 部分高频接口（如分钟线、资金流向）需要较高的 Tushare 积分。如果日志提示权限不足，请检查账号积分。
   - 免费用户受每分钟访问次数（RPM）限制，程序会自动触发 `sleep` 等待，这是正常现象。

2. **DuckDB 写锁**:
   - DuckDB 是单进程写锁数据库。**程序运行期间，请勿使用 DBeaver 或 Python 其他脚本同时连接同一个 `.db` 文件**，否则会报错 `IO Error: Cannot open file ... because it is being used by another process`。
   - 读取（Read-only）通常不受影响，但在写入大量数据时建议保持独占访问。

3. **内存使用**:
   - 大表（如 `daily` 全量历史）更新时，程序采用了分批处理（Batch Size），一般不会造成内存溢出。但如果修改 `settings.yaml` 将分页设置过大，可能会增加内存压力。

4. **配置文件修改**:
   - 修改 `settings.yaml` 中的 SQL 字段定义（`fields`）后，如果数据库中已存在旧表结构，可能会导致插入失败。此时建议删除旧表或手动调整数据库结构。

5. **数据路径**:
   - 默认数据库路径由环境配置 `DB_ROOT` 决定。如果我们在代码中通过 `export DB_ROOT=...` 覆盖了它，请确保该路径有写入权限。

## 7. 常见问题
- **Q: 为什么日志显示“空数据，无需存储”？**
  - A: 可能是当天休市（非交易日），或者该时间段的数据 Tushare 尚未更新。
- **Q: 如何查看下载进度？**
  - A: 查看 `logs/` 目录下的最新日志文件，里面有详细的 `INFO` 级别记录，包括每页获取的行数。
