# 中国波指 (iVIX) 简易版计算说明与数据偏差分析

本文档详细说明了本项目 (`/src/vix`) 中实现的 VIX 计算方法，特别是数据源的选择，以及这些选择与官方或理论计算可能存在的差异。使用者应当知悉这些差异，以便正确解读计算结果。

## 1. 核心计算逻辑

本项目采用了类似 **CBOE VIX** (基于 **方差互换 Variance Swap** 原理) 的无模型算法 (Model-Free)。
核心公式旨在通过期权价格反推市场对未来30天波动率的预期：

$$ \sigma^2 = \frac{2}{T} \sum_{i} \frac{\Delta K_i}{K_i^2} e^{RT} Q(K_i) - \frac{1}{T} \left( \frac{F}{K_0} - 1 \right)^2 $$

其中使用了**近月**和**次近月**两个期限的合约进行加权插值。

## 2. 数据源与处理 (关键差异)

这是导致计算结果与交易所官方 (如上证 50ETF 波指) 存在差异的主要原因。

### 2.1 期权价格数据 (`Price`)

- **本项目使用**: Tushare `opt_daily` 表中的 **收盘价 (`close`)**。
- **理论/官方标准**: 通常使用 **买卖报价中间价 (Mid-Quote Price)**，即 `(Bid + Ask) / 2`。
- **差异分析**:
    - **流动性影响**: 收盘价基于最后一笔成交，如果某合约当天流动性差（尤其是深度虚值合约），最后一笔成交可能发生在收盘前很久，或者偏离当前的买卖盘口。
    - **买卖价差**: 收盘价可能落在买价或卖价上，而不是中间。这会引入随机噪音。
    - **结果偏差**: 使用收盘价通常会导致计算出的 VIX **偏低** 或 **波动较大**（取决于成交价落在Spread的哪一侧）。对于流动性极好的 50ETF 期权，这个差异通常在可接受范围内，但极端行情下会显著。

### 2.2 无风险利率 (`Risk-Free Rate`)

- **本项目使用**: **Shibor (上海银行间同业拆放利率)**，基于 Tushare `shibor` 表数据进行 **Cubic 插值** 得到对应期限的利率。
- **理论/官方标准**: 即使在中国市场，官方计算有时使用 **国债收益率曲线** 或特定的短期理财利率作为无风险利率代理。CBOE VIX 使用的是美国国债收益率曲线。
- **差异分析**:
    - Shibor 包含了银行信用风险，通常 **高于** 纯粹的无风险利率（国债）。
    - 利率 `R` 在 VIX 公式中出现在 $e^{RT}$ 项。由于 $T$ (期限) 很短（通常<30天），且 $R$ 绝对值较小，**利率选取的微小差异对最终 VIX 结果影响极小**（通常在 0.01-0.05 个点以内）。
    - **结论**: 使用 Shibor 是业界常见的做法，偏差可忽略。

### 2.3 期限计算 (`Time to Maturity`)

- **本项目使用**: **(行权日 - 当前日期) 的自然日天数 / 365**。精度为“天”。
- **理论/官方标准**: CBOE VIX 计算精度精确到 **分钟** (Trading Minutes)。它会计算从当前时刻到行权日早晨结算时刻的具体分钟数。
- **差异分析**:
    - 精度差异会导致 $T$ 值有微小偏差，进而影响 $\frac{1}{T}$ 的权重。
    - 在临近到期日时，这种偏差会放大。但在主力合约（近月/次近月）通常距离到期大于7天的情况下，影响有限。

### 2.4 合约筛选 (`Option Selection`)

- **本项目使用**: 
    - 筛选 `50ETF` 相关合约。
    - 执行价选择逻辑：寻找 `abs(Call - Put)` 最小的执行价作为 $K_0$（平值），然后向两边扩展。
    - **数据缺失**: 如果本地 DuckDB 数据库中缺失某些行权价的合约（例如数据没爬全），会导致积分项 $\sum$ 缺失部分贡献。
- **差异分析**:
    - **关键风险点**: 如果数据库中缺失了深度虚值（Deep OTM）的 Put 合约（往往是在大跌时的黑天鹅保护），VIX 计算值会 **显著偏低**。
    - 官方计算会包含所有挂牌合约。本地数据的完整性至关重要。

## 3. 输出数据结构说明 (Output Data Dictionary)

为了方便用户追溯计算过程，本项目生成了包含详细中间结果的 CSV 文件。以下是各列的含义说明。

### 3.1 汇总结果文件 (`vix_result_*.csv`)

该文件每一行代表一个交易日的 VIX 计算结果及其核心中间变量。

| 列名 (Column) | 含义 (Description) | 来源/计算公式 (Source) |
| :--- | :--- | :--- |
| `date` | 交易日期 (YYYYMMDD) | 输入参数 |
| `vix` | 最终计算得到的 VIX 指数 (年化波动率%) | $100 \times \sqrt{\text{Weighted Variance} \times \frac{365}{30}}$ |
| `near_term` | 近月合约剩余期限 (年) | $T_1$ |
| `next_term` | 次近月合约剩余期限 (年) | $T_2$ |
| `r_near` | 近月期限对应的无风险利率 | Shibor 插值 ($R_1$) |
| `r_next` | 次近月期限对应的无风险利率 | Shibor 插值 ($R_2$) |
| `sigma_sq_near` | 近月合约计算出的方差 ($\sigma_1^2$) | 见公式 $\sigma^2$ |
| `sigma_sq_next` | 次近月合约计算出的方差 ($\sigma_2^2$) | 见公式 $\sigma^2$ |
| `F_near` | 近月远期价格 (Forward Price) | $K_{min\_diff} + e^{RT} (Call - Put)$ |
| `F_next` | 次近月远期价格 (Forward Price) | 同上 |
| `K0_near` | 近月平值执行价 (Strike Cutoff) | 小于 $F$ 的最大执行价 |
| `K0_next` | 次近月平值执行价 (Strike Cutoff) | 同上 |
| `weight` | 30天在近月与次近月间的时间权重 | $\frac{T_2 - 30/365}{T_2 - T_1}$ |
| `weighted_variance` | 加权后的30天方差 | $T_1 \sigma_1^2 w + T_2 \sigma_2^2 (1-w)$ |

### 3.2 详细追溯文件 (`vix_details_near_*.csv` / `vix_details_next_*.csv`)

这两个文件分别记录了 **近月** 和 **次近月** 计算过程中，每一个被纳入计算的期权合约的具体贡献。这是排查数据异常（如某个合约价格错误导致 VIX 暴涨）的最底层数据。

| 列名 (Column) | 含义 (Description) | 来源 (Source) |
| :--- | :--- | :--- |
| `date` | 交易日期 | 对应汇总表的一行 |
| `exercise_price` | 执行价 ($K_i$) | DuckDB `opt_basic` |
| `call` | 认购期权价格 | DuckDB `opt_daily` (close) |
| `put` | 认沽期权价格 | DuckDB `opt_daily` (close) |
| `diff` | 执行价间距 ($\Delta K_i$) | $(K_{i+1} - K_{i-1}) / 2$ |
| `risk_free_rate` | 该期限使用的无风险利率 ($R$) | Shibor 插值 |
| `maturity` | 剩余期限 ($T$) | 计算值 |
| `F` | 当期远期价格 | 中间变量 |
| `K0` | 当期平值执行价cutoff | 中间变量 |
| `Q_K` | **用于计算的价格** ($Q(K_i)$) | 若 $K < K_0$ 取Put, $K > K_0$ 取Call, $K=K_0$ 取均值 |
| `contribution` | **该合约对波动率方差的贡献** | $\frac{\Delta K_i}{K_i^2} e^{RT} Q(K_i)$ |

**使用建议**:
如果发现某天 VIX 异常（例如突然跳变），请打开对应的 `details` CSV，筛选该日期，按 `contribution` 降序排列。通常你会发现某一个深度虚值得 Put 合约贡献了巨大的方差值，进而检查该合约的价格 (`Q_K`) 是否存在数据错误（如价格为 0 或异常高）。
